{{/* layouts/shortcodes/dotmap.html
     Fixed-size dot grid + captions.
     Dots scale with SVG; captions sized by textSize.
     NEW: captionPane="auto" computes width from longest caption.

     Usage:
       {{< dotmap size=7 gap=18 textSize=12 captionPane="auto" >}}
       o * o * | SAGARMATHA. THE HEAD OF THE GODDESS …
       o o * o | TIGER HILL AT DAWN …
       {{< /dotmap >}}

       {{< dotmap size=6 gap=14 textSize=11 captionPane=420 captionMargin=16 >}}
       …rows…
       {{< /dotmap >}}
*/}}

{{- /* Params */ -}}
{{- $size          := float (default 6    (.Get "size")) -}}           {{/* circle radius */}}
{{- $gap           := float (default 12   (.Get "gap")) -}}            {{/* center-to-center spacing */}}
{{- $captionPaneIn := .Get "captionPane" -}}                            {{/* number or "auto" */}}
{{- $captionMargin := float (default 16   (.Get "captionMargin")) -}}
{{- $textSize      := float (default 10   (.Get "textSize")) -}}

{{- $stroke     := default (default "#EFC0C1" .Site.Params.hexTextColor) (.Get "stroke") -}}
{{- $fillActive := default (default "#EFC0C1" .Site.Params.hexTextColor) (.Get "fillActive") -}}
{{- $fillHollow := default (default "#595959"  .Site.Params.fillHollow)  (.Get "fillHollow") -}}
{{- $fillFaint  := default (default "#352D2F"  .Site.Params.fillFaint)   (.Get "fillFaint") -}}
{{- $textColor  := default (default "#EFC0C1"  .Site.Params.hexTextColor) (.Get "textColor") -}}

{{/* Parse rows: "o * · * | CAPTION" */}}
{{- $raw  := trim .Inner "\r\n\t " -}}
{{- $rows := slice -}}
{{- range (split $raw "\n") -}}
  {{- $line := trim . " \t" -}}
  {{- if ne $line "" -}}
    {{- $parts := split $line "|" -}}
    {{- $left  := trim (index $parts 0) " \t" -}}
    {{- $left  = replaceRE `\s+` " " $left -}}
    {{- $cols  := cond (ne $left "") (split $left " ") (slice) -}}
    {{- $cap   := "" -}}
    {{- if gt (len $parts) 1 -}}{{- $cap = trim (index $parts 1) " \t" -}}{{- end -}}
    {{- $rows = $rows | append (dict "cols" $cols "caption" $cap) -}}
  {{- end -}}
{{- end -}}

{{/* Grid metrics */}}
{{- $rowCount := len $rows -}}
{{- $maxCols  := 0 -}}
{{- range $rows -}}
  {{- $n := len (index . "cols") -}}
  {{- if gt $n $maxCols -}}{{- $maxCols = $n -}}{{- end -}}
{{- end -}}

{{- $pad := mul $size 1.5 -}}  {{/* visual breathing room */}}
{{- $colsMinus := sub (cond (gt $maxCols 0) $maxCols 1) 1 -}}
{{- $rowsMinus := sub (cond (gt $rowCount 0) $rowCount 1) 1 -}}

{{- $gridW := add (mul (float $colsMinus) $gap) (mul 2 $pad) -}}
{{- $gridH := add (mul (float $rowsMinus) $gap) (mul 2 $pad) -}}

{{/* Auto caption width: estimate by character count in a mono font (~0.62em per char) */}}
{{- $maxChars := 0 -}}
{{- range $rows -}}
  {{- $cap := index . "caption" -}}
  {{- if gt (len $cap) $maxChars -}}{{- $maxChars = len $cap -}}{{- end -}}
{{- end -}}
{{- $autoPane := add (mul (mul $textSize 0.62) (float $maxChars)) 12 -}}  {{/* +12px buffer */}}

{{- /* Final caption pane width decision */ -}}
{{- $pane := 0.0 -}}
{{- if $captionPaneIn -}}
  {{- if eq (lower (printf "%v" $captionPaneIn)) "auto" -}}
    {{- $pane = $autoPane -}}
  {{- else -}}
    {{- $pane = float $captionPaneIn -}}
  {{- end -}}
{{- else -}}
  {{- $pane = 420 -}} {{/* default if not provided */}}
{{- end -}}

{{- $viewW := add $gridW (add $captionMargin $pane) -}}
{{- $viewH := $gridH -}}

<svg class="dotmap" xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 {{ $viewW }} {{ $viewH }}"
     preserveAspectRatio="xMinYMin meet"
     aria-label="Dot grid with captions">
  <style>
    .dotmap .dot { stroke: {{ $stroke }}; stroke-width: 1.25; }
    .dotmap .dot-hollow { fill: {{ $fillHollow }}; }
    .dotmap .dot-filled { fill: {{ $fillActive }}; }
    .dotmap .dot-faint  { fill: {{ $fillFaint  }}; }
    .dotmap .row-caption {
      fill: {{ $textColor }};
      font-family: "IBM Plex Mono", monospace;
      font-size: {{ $textSize }}px;
      dominant-baseline: middle;
      text-anchor: start;
      white-space: pre; /* keep spacing */
    }
  </style>

  {{- range $r, $row := $rows }}
    {{- $cols := index $row "cols" -}}
    {{- $cap  := index $row "caption" -}}
    {{- $colsInRow := len $cols -}}

    {{- $rowWidth := cond (gt $colsInRow 0) (mul (float (sub $colsInRow 1)) $gap) 0 -}}
    {{- $maxWidth := cond (gt $maxCols   0) (mul (float (sub $maxCols   1)) $gap) 0 -}}
    {{- $xOffset  := add $pad (div (sub $maxWidth $rowWidth) 2) -}}
    {{- $y        := add $pad (mul (float $r) $gap) -}}

    {{- /* dots */ -}}
    {{- range $c, $token := $cols }}
      {{- $t := lower (trim $token " ") -}}
      {{- if and (ne $t "") (ne $t "-") -}}
        {{- $x := add $xOffset (mul (float $c) $gap) -}}
        {{- $cls := cond (or (eq $t "·") (eq $t ".")) "dot dot-faint" (cond (eq $t "*") "dot dot-filled" "dot dot-hollow") -}}
        <circle class="{{ $cls }}" cx="{{ $x }}" cy="{{ $y }}" r="{{ $size }}" />
      {{- end -}}
    {{- end }}

    {{- /* caption text */ -}}
    {{- if ne $cap "" -}}
      {{- $xText := add (add $xOffset $rowWidth) (add $captionMargin $size) -}}
      <text class="row-caption" x="{{ $xText }}" y="{{ $y }}">{{ $cap }}</text>
    {{- end -}}
  {{- end }}
</svg>
