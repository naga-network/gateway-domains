<!--
{{/* layouts/shortcodes/dotmap.html
     Fixed-size dot grid with per-row captions after a "|" separator.

     Usage:
       {{< dotmap size=6 gap=14 >}}
       o o o o o | THE WAVES AND THE DUNES.
       o * · * o | SOMEWHERE IN THE GREAT THAR DESERT. AT DUSK.
       o o o o o | HOLGA 120 GFCN ... 17x25
       {{< /dotmap >}}

       {{< dotmap size=5 gap=12 captionPane=320 captionMargin=12 textSize=10 >}}
       o o o o | LINE ONE
       o * o o | LINE TWO
       · o o · | LINE THREE
       {{< /dotmap >}}

       {{< dotmap fillActive="#EFC0C1" fillHollow="#595959" fillFaint="#352D2F" stroke="#EFC0C1" textColor="#EFC0C1" >}}
       o * o o o | PINK ACTIVE / GREY HOLLOW
       {{< /dotmap >}}

     Params:
       - size: circle radius (default 6)
       - gap:  spacing between dot centers (default 12)
       - captionPane: reserved width (SVG units) for captions (default 420)
       - captionMargin: spacing from last dot to caption start (default 16)
       - textSize: SVG font-size for captions (default 10)

       - stroke: outline color (default site param hexTextColor or #EFC0C1)
       - fillActive: fill for "*" (default hexTextColor)
       - fillHollow: fill for "o" (default #595959)
       - fillFaint:  fill for "·" or "." (default #352D2F)
       - textColor:  caption color (default hexTextColor)
*/}}
-->
{{- $size          := float (default 6    (.Get "size")) -}}
{{- $gap           := float (default 12   (.Get "gap")) -}}
{{- $captionPane   := float (default 420  (.Get "captionPane")) -}}
{{- $captionMargin := float (default 16   (.Get "captionMargin")) -}}
{{- $textSize      := float (default 10   (.Get "textSize")) -}}

{{- $stroke     := default (default "#EFC0C1" .Site.Params.hexTextColor) (.Get "stroke") -}}
{{- $fillActive := default (default "#EFC0C1" .Site.Params.hexTextColor) (.Get "fillActive") -}}
{{- $fillHollow := default (default "#595959"  .Site.Params.fillHollow)  (.Get "fillHollow") -}}
{{- $fillFaint  := default (default "#352D2F"  .Site.Params.fillFaint)   (.Get "fillFaint") -}}
{{- $textColor  := default (default "#EFC0C1"  .Site.Params.hexTextColor) (.Get "textColor") -}}

{{/* --- Parse inner content into [{cols:[], caption:""}...] --- */}}
{{- $raw := trim .Inner "\r\n\t " -}}
{{- $rows := slice -}}
{{- range (split $raw "\n") -}}
  {{- $line := trim . " \t" -}}
  {{- if ne $line "" -}}
    {{- $parts := split $line "|" -}}
    {{- $left  := trim (index $parts 0) " \t" -}}
    {{- $left  = replaceRE `\s+` " " $left -}}
    {{- $cols  := slice -}}
    {{- if ne $left "" -}}
      {{- $cols = split $left " " -}}
    {{- end -}}
    {{- $cap := "" -}}
    {{- if gt (len $parts) 1 -}}
      {{- $cap = trim (index $parts 1) " \t" -}}
    {{- end -}}
    {{- $rows = $rows | append (dict "cols" $cols "caption" $cap) -}}
  {{- end -}}
{{- end -}}

{{/* --- Geometry: compute max columns, viewBox, padding --- */}}
{{- $rowCount := len $rows -}}
{{- $maxCols := 0 -}}
{{- range $rows -}}
  {{- $n := len (index . "cols") -}}
  {{- if gt $n $maxCols -}}{{- $maxCols = $n -}}{{- end -}}
{{- end -}}

{{- $pad := mul $size 1.5 -}}
{{- $colsMinus := sub (cond (gt $maxCols 0) $maxCols 1) 1 -}}
{{- $rowsMinus := sub (cond (gt $rowCount 0) $rowCount 1) 1 -}}

{{- $gridW := add (mul (float $colsMinus) $gap) (mul 2 $pad) -}}
{{- $viewW := add $gridW (add $captionMargin $captionPane) -}}
{{- $viewH := add (mul (float $rowsMinus) $gap) (mul 2 $pad) -}}

<svg class="dotmap" xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 {{ $viewW }} {{ $viewH }}" aria-label="Dot grid with captions">
  <style>
    .dotmap .dot { stroke: {{ $stroke }}; stroke-width: 1.25; }
    .dotmap .dot-hollow { fill: {{ $fillHollow }}; }
    .dotmap .dot-filled { fill: {{ $fillActive }}; }
    .dotmap .dot-faint  { fill: {{ $fillFaint  }}; }
    .dotmap .row-caption {
      fill: {{ $textColor }};
      font-family: "IBM Plex Mono", monospace;
      font-size: {{ $textSize }}px;
      dominant-baseline: middle;
      text-anchor: start;
      white-space: pre; /* keep spacing */
    }
  </style>

  {{- range $r, $row := $rows }}
    {{- $cols := index $row "cols" -}}
    {{- $cap  := index $row "caption" -}}
    {{- $colsInRow := len $cols -}}

    {{- $rowWidth  := mul (float (sub (cond (gt $colsInRow 0) $colsInRow 1) 1)) $gap -}}
    {{- $maxWidth  := mul (float (sub (cond (gt $maxCols 0)  $maxCols  1) 1)) $gap -}}
    {{- $xOffset   := add $pad (div (sub $maxWidth $rowWidth) 2) -}}
    {{- $y         := add $pad (mul (float $r) $gap) -}}

    {{- /* dots */ -}}
    {{- range $c, $token := $cols }}
      {{- $t := lower (trim $token " ") -}}
      {{- if and (ne $t "") (ne $t "-") -}}
        {{- $x := add $xOffset (mul (float $c) $gap) -}}
        {{- $cls := cond (or (eq $t "·") (eq $t ".")) "dot dot-faint" (cond (eq $t "*") "dot dot-filled" "dot dot-hollow") -}}
        <circle class="{{ $cls }}" cx="{{ $x }}" cy="{{ $y }}" r="{{ $size }}" />
      {{- end -}}
    {{- end }}

    {{- /* caption text */ -}}
    {{- if ne $cap "" -}}
      {{- $xText := add (add $xOffset $rowWidth) (add $captionMargin $size) -}}
      <text class="row-caption" x="{{ $xText }}" y="{{ $y }}">{{ $cap }}</text>
    {{- end -}}
  {{- end }}
</svg>
